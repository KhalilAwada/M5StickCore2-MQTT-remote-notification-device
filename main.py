"""
M5Stack Core 2 - UIFlow2 Application
Generated by UIFlow2 GUI Web IDE

IMPORTANT: Uses M5UI (m5ui + lvgl) library - NOT M5GFX
Features:
- WiFi connectivity from SD card config
- MQTT integration
- SD card file reading
- Multi-page UI with LVGL
"""

import os, sys, io
import M5
from M5 import BtnA
import m5ui
import lvgl as lv
from hardware import sdcard
import time
import network
import json



# UI Components (global - used across multiple functions)
dashboard = None  # type: m5ui.M5Page
github = None  # type: m5ui.M5Page
github_list = None  # type: m5ui.M5List
text = None  # type: m5ui.M5TextItem
msgboxError = None  # type: m5ui.M5Msgbox
ErrorMSGLBL = None  # type: m5ui.M5TextItem
ErrorOKBTN = None  # type: m5ui.M5Button
github_page_title = None  # type: m5ui.M5Label
dashboard_page_title = None  # type: m5ui.M5Label
label0 = None  # type: m5ui.M5Label
label_kzz = None  # type: m5ui.M5TextItem

# Network and Configuration (global - shared state)
wlan_sta = None  # type: network.WLAN
wifiCredsJSON = None  # type: list
mqttCredsJSON = None  # type: dict
mqttMessages = None
pageIndex = None  # type: int


def reportError(errorMessage):
  """Display error message in UI msgbox"""
  global msgboxError, ErrorMSGLBL, github_page_title
  print('Error:', errorMessage)
  ErrorMSGLBL.set_text(str(errorMessage))
  msgboxError.set_flag(lv.obj.FLAG.HIDDEN, False)
  github_page_title.set_text(str(errorMessage))

def showLoading(show, title):
  """Show/hide loading indicator (placeholder for future implementation)"""
  # No globals needed - only uses parameters
  if show:
    print('Loading:', title)
  else:
    print('Loading complete')

def checkTime(x):
  """Check if current time is divisible by x (for periodic tasks)"""
  # No globals needed - pure function
  return (time.time()) % (int(x)) == 0


def readSDFile(fileName, returnJSON):
  """
  Read file from SD card
  Args:
    fileName: Name of file in /sd/ directory
    returnJSON: If True, parse as JSON and return dict/list, else return string
  Returns:
    Parsed JSON object or string, None on error
  """
  # No globals needed - all variables are local
  showLoading(True, f'Loading {fileName}')
  try:
    with open('/sd/' + str(fileName), 'r') as ffile:
      fileLines = ffile.readlines()
    
    fileString = ''
    for line in fileLines:
      if len(line.strip()) > 0:
        fileString += line.strip()
    
    fileString = fileString.strip()
    returnValue = json.loads(fileString) if returnJSON else fileString
    print(f'Successfully loaded {fileName}')
  except Exception as e:
    print(f'ERROR in readSDFile: {e}')
    sys.print_exception(e)
    reportError(f'Failed to load {fileName}: {e}')
    returnValue = None
  
  showLoading(False, '')
  return returnValue


def connectWifi(credentials):
  """
  Connect to WiFi using credentials from config
  Args:
    credentials: List of dicts with 'ssid' and 'password' keys
  """
  global wlan_sta, label0
  
  # Build WiFi credentials map (local variable)
  wifi_map = {}
  for cred in credentials:
    wifi_map[cred['ssid']] = cred['password']
    label0.set_text(f"Checking: {cred['ssid']}")
    time.sleep(1)
  
  wlan_sta.config(reconnects=5)
  wlan_sta.config(dhcp_hostname='m5stack')
  
  # Scan and connect to available network
  while not wlan_sta.isconnected():
    for sta_record in wlan_sta.scan():
      ssid = sta_record[0].decode()
      if ssid in wifi_map:
        wlan_sta.active(False)
        wlan_sta.active(True)
        showLoading(True, f'Connecting to {ssid}')
        wlan_sta.connect(ssid, wifi_map[ssid])
        time.sleep(5)
        showLoading(False, '')
        if wlan_sta.isconnected():
          print(f'Connected to {ssid}')
          label0.set_text(f'Connected: {ssid}')
          return


def renderList():
  """Render example list items (demo function)"""
  global github_list
  
  # Demo data (local variable)
  demo_data = '[{"id": 28, "Title": "Sweden"}, {"id": 56, "Title": "USA"}, {"id": 89, "Title": "England"}]'
  items = json.loads(demo_data)
  
  for item in items:
    label = github_list.add_text(f"{item['id']} - {item['Title']}")
    label.move_background()
    time.sleep(2)

def loadMQTTMessages():
  """Load MQTT messages from SD card"""
  global github_page_title
  
  messages = readSDFile('mqtt-messages.json', True)
  if messages:
    github_page_title.set_text('MQTT Messages Loaded')
  return messages


# Event Handlers
def ErrorOKBTN_released_event(event_struct):
  """Handle error dialog OK button click"""
  global msgboxError
  msgboxError.set_flag(lv.obj.FLAG.HIDDEN, True)


def btnA_wasClicked_event(state):
  """Handle Button A click - switch to github page"""
  global github
  github.screen_load()


def ErrorOKBTN_event_handler(event_struct):
  """LVGL event handler wrapper for error OK button"""
  # No globals needed - delegates to ErrorOKBTN_released_event
  event = event_struct.code
  if event == lv.EVENT.RELEASED:
    ErrorOKBTN_released_event(event_struct)
  return

def setup():
  """Initialize M5Stack, UI, and load configuration"""
  global dashboard, github, github_list, text, msgboxError, ErrorMSGLBL, ErrorOKBTN
  global github_page_title, dashboard_page_title, label0
  global wlan_sta, wifiCredsJSON, mqttCredsJSON, mqttMessages, pageIndex

  # Initialize M5Stack and UI
  M5.begin()
  M5.Widgets.setRotation(1)
  m5ui.init()
  
  # Create pages
  dashboard = m5ui.M5Page(bg_c=0xffffff)
  github = m5ui.M5Page(bg_c=0xffffff)
  
  # Create UI elements on github page
  github_list = m5ui.M5List(x=2, y=22, w=315, h=215, parent=github)
  text = github_list.add_text("text")
  github_page_title = m5ui.M5Label("Github", x=0, y=0, text_c=0x000000, bg_c=0xffffff, bg_opa=0, font=lv.font_montserrat_14, parent=github)
  
  # Create UI elements on dashboard page
  msgboxError = m5ui.M5Msgbox(title="Error", x=61, y=219, w=200, h=180, parent=dashboard)
  ErrorMSGLBL = msgboxError.add_text("Error message will appear here")
  ErrorOKBTN = msgboxError.add_button(text="OK", option="footer")
  msgboxError.add_close_button()
  msgboxError.set_flag(lv.obj.FLAG.HIDDEN, True)  # Hide by default
  
  dashboard_page_title = m5ui.M5Label("Dashboard", x=0, y=0, text_c=0x000000, bg_c=0xffffff, bg_opa=0, font=lv.font_montserrat_14, parent=dashboard)
  label0 = m5ui.M5Label("Initializing...", x=62, y=57, text_c=0x000000, bg_c=0xffffff, bg_opa=0, font=lv.font_montserrat_14, parent=dashboard)

  # Setup event handlers
  ErrorOKBTN.add_event_cb(ErrorOKBTN_event_handler, lv.EVENT.ALL, None)
  BtnA.setCallback(type=BtnA.CB_TYPE.WAS_CLICKED, cb=btnA_wasClicked_event)

  # Initialize SD card
  try:
    sdcard.SDCard(slot=2, width=1, sck=18, miso=38, mosi=23, cs=4, freq=1000000)
    print('SD card initialized')
  except Exception as e:
    print(f'ERROR: SD card init failed: {e}')
    sys.print_exception(e)
  
  # Initialize WiFi
  wlan_sta = network.WLAN(network.STA_IF)
  wlan_sta.config(reconnects=3)
  
  # Load configuration files from SD card
  wifiCredsJSON = readSDFile('wifi.json', True)
  mqttCredsJSON = readSDFile('mqtt.json', True)
  
  # Show dashboard
  dashboard.screen_load()
  
  # Display loaded config (for debugging)
  if wifiCredsJSON:
    label0.set_text('WiFi config loaded')
  else:
    label0.set_text('No WiFi config found')
  
  # Load MQTT messages
  mqttMessages = loadMQTTMessages()
  
  # Connect to WiFi if config available
  if wifiCredsJSON:
    connectWifi(wifiCredsJSON)
  
  pageIndex = 0
  print('Setup complete')


def loop():
  """Main application loop - runs continuously"""
  global wlan_sta, label0, wifiCredsJSON
  
  M5.update()
  
  # Check WiFi connection every 30 seconds
  if checkTime(30):
    status = 'Connected' if wlan_sta.isconnected() else 'Disconnected'
    label0.set_text(f'{status} - {time.time()}')
    
    # Reconnect if disconnected
    if not wlan_sta.isconnected() and wifiCredsJSON:
      print('WiFi disconnected, reconnecting...')
      connectWifi(wifiCredsJSON)
  
  # Render list every 60 seconds
  if checkTime(60):
    renderList()


if __name__ == '__main__':
  try:
    setup()
    while True:
      loop()
  except (Exception, KeyboardInterrupt) as e:
    print(f'\nFATAL ERROR: {e}')
    try:
      sys.print_exception(e)
    except:
      pass
    try:
      m5ui.deinit()
      from utility import print_error_msg
      print_error_msg(e)
    except ImportError:
      print("Please update to latest firmware")
    except Exception as cleanup_error:
      print(f"Cleanup error: {cleanup_error}")
